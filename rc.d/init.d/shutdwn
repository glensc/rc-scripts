#!/bin/sh
#
# shutdwn       Common script for system halt/reboot.
#
# Author:       Miquel van Smoorenburg, <miquels@drinkel.nl.mugnet.org>
#               Modified for PLD Linux by Grzegorz Stanislawski
# Changes:      Arkadiusz Mi¶kiewicz <misiek@pld.org.pl>
#

# Set the path.
PATH=/sbin:/bin:/usr/bin:/usr/sbin

. /etc/rc.d/init.d/functions

# Kill all processes.
[ "${BASH+bash}" = bash ] && enable kill

show "Sending all processes the TERM signal "
daemon killall5 -15
sleep 5
show "Sending all processes the KILL signal "
daemon killall5 -9

# Write to wtmp file before unmounting /var
halt -w

# Turn off swap, then unmount file systems.
show "Turning off swap and accounting"
daemon swapoff -a
[ -x /sbin/accton ] && /sbin/accton
show "Unmounting file systems"; busy
if ( umount -a; mount -n -o remount,ro / ); then
deltext; ok
else
deltext; fail
fi

# turn off raid
if [ -x /sbin/raidstop -a -f /etc/raidtab ]; then
    /sbin/raidstop -a
fi

show "Remounting remaining filesystems ro mode"; busy
if (mount | awk '/ext2/ { print $3 }' | while read line; do 
    mount -n -o ro,remount $line
done); then
deltext; ok
else
deltext; fail
fi
